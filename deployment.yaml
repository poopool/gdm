imports:
- path: forwarding_rule_v1.py
- path: network_v1.py
- path: vpn_gateway_v1.py
- path: vpn_tunnel_v1.py
- path: route_v1.py
- path: static_ip_v1.py

resources:
#create vpc network with auto-generated subnets
- type: network_v1.py
  name: network-v1-test
  properties:
    autoCreateSubnetworks: True
#reserve a static IP for the vpn gateway
- type: static_ip_v1.py
  name: vpn-static-ip
  properties:
    region: us-central
#create vpn gateway in above vpc
- type: vpn_gateway_v1.py
  name: vpn1
  properties:
    region: us-central
    network: $(ref.network-v1-test.selfLink)
#create a forwarding rule that forwards ESP traffic toward the Cloud VPN gateway
- type: forwarding_rule_v1.py
  name: fr-esp
  properties:
    region: us-central
    IPProtocol: ESP
    IPAddress: $(ref.vpn-static-ip.address)
    network: $(ref.network-v1-test.selfLink)
    target: $(ref.vpn1.selfLink)
#forwarding rule - UDP 500
- type: forwarding_rule_v1.py
  name: fr-udp500
  properties:
    region: us-central
    IPProtocol: UDP
    portRange: 500
    IPAddress: $(ref.vpn-static-ip.address)
    network: $(ref.network-v1-test.selfLink)
    target: $(ref.vpn1.selfLink)
#forwarding rule - UDP 4500
- type: forwarding_rule_v1.py
  name: fr-udp4500
  properties:
    region: us-central
    IPProtocol: UDP
    portRange: 4500
    IPAddress: $(ref.vpn-static-ip.address)
    network: $(ref.network-v1-test.selfLink)
    target: $(ref.vpn1.selfLink)
#create tunnel
- type: vpn_tunnel_v1.py
  name: tunnel1
  properties:
    region: us-central
    forwardingRule: $(ref.fr-udp4500.selfLink)
    ikeVersion: 2
    peerIp: 1.2.3.4/32
    sharedSecret: test123
    targetVpnGateway: $(ref.vpn1.selfLink)
#create route - all traffic outbound goes to peer network
- type: route_v1.py
  name: route1
  properties:
    network: $(ref.network-v1-test.selfLink)
    nextHopVpnTunnel: $(ref.tunnel1.selfLink)
    priority: 100
    destRange: 0.0.0.0/0

## We will also need to create a firewall rule to allow inbound from peer network like below
## FIREWALL - ALLOW ALL INBOUND FROM PEER NETWORK
#- type: compute.v1.firewall
#  name: vpn-rule
#  properties:
#    network: $(ref.network-v1-test.selfLink)
#    sourceRanges:
#      - {{ properties["sourceRanges"] }}
#    allowed:
#      - IPProtocol: tcp
#      - IPProtocol: udp
#      - IPProtocol: icmp